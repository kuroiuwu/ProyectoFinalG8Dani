@model IEnumerable<ProyectoFinal_G8.Models.Mascota>
@using Microsoft.AspNetCore.Identity
@using ProyectoFinal_G8.Models
@inject UserManager<Usuario> UserManager

@{
    ViewData["Title"] = "Mis Mascotas"; 
    string currentUserIdString = UserManager.GetUserId(User);
    int.TryParse(currentUserIdString, out int currentUserID); // Asume que IdUsuario es int
}

<div class="container mt-4">
    <h1>@ViewData["Title"]</h1>
    <hr />

    @* Mostrar mensajes TempData si existen *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }


    @* Botón Crear: Visible para todos los roles? O solo Admin? Ajusta User.IsInRole si es necesario *@
    @if (User.IsInRole("Admin") || User.IsInRole("Cliente") || User.IsInRole("Veterinario")) // Ejemplo: Todos pueden crear
    {
        <p>
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus mr-1"></i> @(User.IsInRole("Cliente") ? "Registrar Nueva Mascota" : "Crear Nueva Mascota")
            </a>
        </p>
    }


    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="thead-light">
                <tr>
                    <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Nombre)</th>
                    <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Especie)</th>
                    <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Raza)</th>
                    <th>@Html.DisplayNameFor(model => model.FirstOrDefault().FechaNacimiento)</th>
                    @* Mostrar dueño solo si es Admin/Vet (Cliente ya sabe que son suyas) *@
                    @if (User.IsInRole("Admin") || User.IsInRole("Veterinario"))
                    {
                        <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Dueño)</th>
                    }
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="@(User.IsInRole("Admin") || User.IsInRole("Veterinario") ? "6" : "5")" class="text-center">
                            @(User.IsInRole("Cliente") ? "No tienes mascotas registradas." : "No hay mascotas para mostrar.")
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in Model)
                    {
                        // Determinar permisos para esta fila específica
                        bool isAdminOrVet = User.IsInRole("Admin") || User.IsInRole("Veterinario");
                        // *** Usando IdUsuarioDueño ***
                        bool isOwner = User.IsInRole("Cliente") && item.IdUsuarioDueño == currentUserID;

                        
                        bool canManage = isAdminOrVet || isOwner; 
                        bool canViewHistory = isAdminOrVet || isOwner;
                        bool canViewDetails = true;

                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.Nombre)</td>
                            <td>@Html.DisplayFor(modelItem => item.Especie)</td>
                            <td>@Html.DisplayFor(modelItem => item.Raza)</td>
                            <td>@(item.FechaNacimiento?.ToString("d") ?? "N/A")</td> @* Formato corto fecha - CORREGIDO *@

                            @if (User.IsInRole("Admin") || User.IsInRole("Veterinario"))
                            {
                                <td>@(item.Dueño?.Nombre ?? "N/A")</td> @* Asume Dueño cargado *@
                            }

                            <td>
                                <div class="btn-group" role="group" aria-label="Acciones Mascota">

                                    @if (canViewDetails)
                                    {
                                        <a asp-action="Details" asp-route-id="@item.IdMascota" class="btn btn-info" title="Ver Detalles"><i class="fas fa-info-circle"></i></a>
                                    }

                                    @* --- Condición EDITAR: Admin, Vet o Cliente dueño --- *@
                                    @if (canManage)
                                    {
                                        <a asp-action="Edit" asp-route-id="@item.IdMascota" class="btn btn-warning" title="Editar"><i class="fas fa-pencil-alt"></i></a>
                                    }

                                    @* --- Condición ELIMINAR: SOLO Admin o Vet --- *@
                                    @if (isAdminOrVet) // <--- Solo Admin/Vet pueden ver Eliminar
                                    {
                                        <a asp-action="Delete" asp-route-id="@item.IdMascota" class="btn btn-danger" title="Eliminar"><i class="fas fa-trash-alt"></i></a>
                                    }

                                    @if (canViewHistory)
                                    {
                                        <a asp-controller="HistorialMedicos"
                                           asp-action="Index"
                                           asp-route-mascotaId="@item.IdMascota"
                                           class="btn btn-secondary"
                                           title="Ver Historial Médico"><i class="fas fa-notes-medical"></i></a>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Script para cerrar alerts de Bootstrap 5 (si lo usas)
        var alertList = document.querySelectorAll('.alert');
        alertList.forEach(function (alert) {
          new bootstrap.Alert(alert);
        });
    </script>
}